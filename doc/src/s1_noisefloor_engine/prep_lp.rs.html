<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source to the Rust file `engine/src/prep_lp.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>prep_lp.rs.html -- source</title><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../dark.css"><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script src="../../storage.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="shortcut icon" href="../../favicon.ico"><style type="text/css">#crate-search{background-image:url("../../down-arrow.svg");}</style></head><body class="rustdoc source"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../s1_noisefloor_engine/index.html'><div class='logo-container'><img src='../../rust-logo.png' alt='logo'></div></a></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../../settings.html"><img src="../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><pre class="line-numbers"><span id="1">  1</span>
<span id="2">  2</span>
<span id="3">  3</span>
<span id="4">  4</span>
<span id="5">  5</span>
<span id="6">  6</span>
<span id="7">  7</span>
<span id="8">  8</span>
<span id="9">  9</span>
<span id="10"> 10</span>
<span id="11"> 11</span>
<span id="12"> 12</span>
<span id="13"> 13</span>
<span id="14"> 14</span>
<span id="15"> 15</span>
<span id="16"> 16</span>
<span id="17"> 17</span>
<span id="18"> 18</span>
<span id="19"> 19</span>
<span id="20"> 20</span>
<span id="21"> 21</span>
<span id="22"> 22</span>
<span id="23"> 23</span>
<span id="24"> 24</span>
<span id="25"> 25</span>
<span id="26"> 26</span>
<span id="27"> 27</span>
<span id="28"> 28</span>
<span id="29"> 29</span>
<span id="30"> 30</span>
<span id="31"> 31</span>
<span id="32"> 32</span>
<span id="33"> 33</span>
<span id="34"> 34</span>
<span id="35"> 35</span>
<span id="36"> 36</span>
<span id="37"> 37</span>
<span id="38"> 38</span>
<span id="39"> 39</span>
<span id="40"> 40</span>
<span id="41"> 41</span>
<span id="42"> 42</span>
<span id="43"> 43</span>
<span id="44"> 44</span>
<span id="45"> 45</span>
<span id="46"> 46</span>
<span id="47"> 47</span>
<span id="48"> 48</span>
<span id="49"> 49</span>
<span id="50"> 50</span>
<span id="51"> 51</span>
<span id="52"> 52</span>
<span id="53"> 53</span>
<span id="54"> 54</span>
<span id="55"> 55</span>
<span id="56"> 56</span>
<span id="57"> 57</span>
<span id="58"> 58</span>
<span id="59"> 59</span>
<span id="60"> 60</span>
<span id="61"> 61</span>
<span id="62"> 62</span>
<span id="63"> 63</span>
<span id="64"> 64</span>
<span id="65"> 65</span>
<span id="66"> 66</span>
<span id="67"> 67</span>
<span id="68"> 68</span>
<span id="69"> 69</span>
<span id="70"> 70</span>
<span id="71"> 71</span>
<span id="72"> 72</span>
<span id="73"> 73</span>
<span id="74"> 74</span>
<span id="75"> 75</span>
<span id="76"> 76</span>
<span id="77"> 77</span>
<span id="78"> 78</span>
<span id="79"> 79</span>
<span id="80"> 80</span>
<span id="81"> 81</span>
<span id="82"> 82</span>
<span id="83"> 83</span>
<span id="84"> 84</span>
<span id="85"> 85</span>
<span id="86"> 86</span>
<span id="87"> 87</span>
<span id="88"> 88</span>
<span id="89"> 89</span>
<span id="90"> 90</span>
<span id="91"> 91</span>
<span id="92"> 92</span>
<span id="93"> 93</span>
<span id="94"> 94</span>
<span id="95"> 95</span>
<span id="96"> 96</span>
<span id="97"> 97</span>
<span id="98"> 98</span>
<span id="99"> 99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
</pre><div class="example-wrap"><pre class="rust ">
<span class="doccomment">//! Top level module for preparing measurements for the linear programming implementation.</span>
<span class="doccomment">//! This is everything up-to the actual program estimation</span>
<span class="comment">/*
MIT License

Copyright (c) 2020 Peter Lee

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/</span>

<span class="kw">use</span> <span class="kw">crate</span>::<span class="ident">parse</span>::{<span class="ident">BurstEntry</span>, <span class="ident">TimeRowLut</span>, <span class="ident">RawPattern</span>, <span class="ident">HyperParams</span>};
<span class="kw">use</span> <span class="kw">crate</span>::<span class="ident">read_from_archive</span>::<span class="ident">SentinelFormatId</span>;
<span class="kw">use</span> <span class="ident">lapack</span>::<span class="kw-2">*</span>;
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">sync</span>::{<span class="ident">Arc</span>, <span class="ident">Mutex</span>};
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">ops</span>::{<span class="ident">Index</span>, <span class="ident">IndexMut</span>};

<span class="comment">// FFT libs for fast convolution.</span>
<span class="kw">use</span> <span class="ident">rustfft</span>::<span class="ident">FFTplanner</span>;
<span class="kw">use</span> <span class="ident">rustfft</span>::<span class="ident">num_complex</span>::<span class="ident">Complex64</span>;
<span class="kw">use</span> <span class="ident">ndarray</span>::{<span class="ident">Array2</span>, <span class="ident">ArrayView</span>, <span class="ident">Ix2</span>};
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">thread</span>;

<span class="kw">pub</span> <span class="kw">type</span> <span class="ident">ArrToArr</span> <span class="op">=</span> <span class="ident">Arc</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="ident">Fn</span>(<span class="kw-2">&amp;</span>[<span class="ident">usize</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span> <span class="op">+</span> <span class="ident">Sync</span> <span class="op">+</span> <span class="ident">Send</span><span class="op">&gt;</span> ;

<span class="attribute">#[<span class="ident">derive</span>(<span class="ident">Debug</span>)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">TwoDArray</span>{
    <span class="kw">pub</span> <span class="ident">rows</span>:<span class="ident">usize</span>,
    <span class="kw">pub</span> <span class="ident">cols</span>:<span class="ident">usize</span>,
    <span class="ident">data</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>
}

<span class="kw">impl</span> <span class="ident">Index</span><span class="op">&lt;</span>(<span class="ident">usize</span>, <span class="ident">usize</span>)<span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">TwoDArray</span> {
    <span class="kw">type</span> <span class="ident">Output</span> <span class="op">=</span> <span class="ident">f64</span>;
    <span class="doccomment">///column major order</span>
    <span class="kw">fn</span> <span class="ident">index</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">x</span>:(<span class="ident">usize</span>, <span class="ident">usize</span>)) <span class="op">-</span><span class="op">&gt;</span> <span class="kw-2">&amp;</span><span class="ident">f64</span>{
	<span class="comment">//&amp;self.data[x.0 + x.1*self.rows]</span>
	<span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">data</span>[<span class="ident">x</span>.<span class="number">1</span> <span class="op">+</span> <span class="ident">x</span>.<span class="number">0</span><span class="kw-2">*</span><span class="self">self</span>.<span class="ident">cols</span>]
    }
}

<span class="kw">impl</span> <span class="ident">IndexMut</span><span class="op">&lt;</span>(<span class="ident">usize</span>, <span class="ident">usize</span>)<span class="op">&gt;</span> <span class="kw">for</span> <span class="ident">TwoDArray</span> {
    <span class="kw">fn</span> <span class="ident">index_mut</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>, <span class="ident">x</span>:(<span class="ident">usize</span>, <span class="ident">usize</span>)) <span class="op">-</span><span class="op">&gt;</span> <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">Self</span>::<span class="ident">Output</span> {
	<span class="comment">//&amp;mut self.data[x.0 + x.1*self.rows]</span>
	<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>.<span class="ident">data</span>[<span class="ident">x</span>.<span class="number">1</span> <span class="op">+</span> <span class="ident">x</span>.<span class="number">0</span><span class="kw-2">*</span><span class="self">self</span>.<span class="ident">cols</span>]
    }
}

<span class="kw">impl</span> <span class="ident">TwoDArray</span> {
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">zeros</span>(<span class="ident">row</span>:<span class="ident">usize</span>, <span class="ident">col</span>:<span class="ident">usize</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">TwoDArray</span> {
	<span class="ident">TwoDArray</span> {
	    <span class="ident">rows</span>:<span class="ident">row</span>,
	    <span class="ident">cols</span>:<span class="ident">col</span>,
	    <span class="ident">data</span>:<span class="macro">vec</span><span class="macro">!</span>[<span class="number">0.0</span>;<span class="ident">row</span><span class="kw-2">*</span><span class="ident">col</span>]
	}
    }

    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">from_ndarray</span>(<span class="ident">ndarr</span>:<span class="ident">Array2</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">TwoDArray</span> {
	<span class="kw">let</span> <span class="ident">row</span> <span class="op">=</span> <span class="ident">ndarr</span>.<span class="ident">nrows</span>();
	<span class="kw">let</span> <span class="ident">col</span> <span class="op">=</span> <span class="ident">ndarr</span>.<span class="ident">ncols</span>();
	
	<span class="kw">if</span> <span class="ident">ndarr</span>.<span class="ident">is_standard_layout</span>() {
	    <span class="kw">return</span> <span class="ident">TwoDArray</span>{
		<span class="ident">rows</span>:<span class="ident">row</span>,
		<span class="ident">cols</span>:<span class="ident">col</span>,
		<span class="ident">data</span>:<span class="ident">ndarr</span>.<span class="ident">into_raw_vec</span>()
	    };
	}
	<span class="kw">else</span> {
	    <span class="kw">return</span> <span class="ident">TwoDArray</span>{
		<span class="ident">rows</span>:<span class="ident">row</span>,
		<span class="ident">cols</span>:<span class="ident">col</span>,
		<span class="ident">data</span>:<span class="ident">ndarr</span>.<span class="ident">reversed_axes</span>().<span class="ident">into_raw_vec</span>()
	    };
	}
    }
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">to_raw_pointer</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">f64</span> {
	<span class="self">self</span>.<span class="ident">data</span>.<span class="ident">as_mut_ptr</span>()
    }
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">from_vec</span>(<span class="ident">s</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>, <span class="ident">row</span>:<span class="ident">usize</span>, <span class="ident">col</span>:<span class="ident">usize</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">TwoDArray</span> {
	<span class="ident">TwoDArray</span> {
	    <span class="ident">rows</span>:<span class="ident">row</span>,
	    <span class="ident">cols</span>:<span class="ident">col</span>,
	    <span class="ident">data</span>:<span class="ident">s</span>,
	}
    }
    
    <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">to_ndarray</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span><span class="op">&gt;</span>(<span class="kw-2">&amp;</span><span class="lifetime">&#39;a</span> <span class="self">self</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">ArrayView</span><span class="op">&lt;</span><span class="lifetime">&#39;a</span>, <span class="ident">f64</span>, <span class="ident">Ix2</span><span class="op">&gt;</span> {
	<span class="ident">ArrayView</span>::<span class="ident">from_shape</span>((<span class="self">self</span>.<span class="ident">rows</span>, <span class="self">self</span>.<span class="ident">cols</span>),
			      <span class="kw-2">&amp;</span><span class="self">self</span>.<span class="ident">data</span>).<span class="ident">unwrap</span>()
    }
}

<span class="macro">macro_rules</span><span class="macro">!</span> <span class="ident">get_num_subswath</span> {
    (<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>:<span class="ident">expr</span>) <span class="op">=</span><span class="op">&gt;</span> {
	<span class="kw">match</span> <span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">sentmode</span>.<span class="ident">as_str</span>() {
	    <span class="string">&quot;EW&quot;</span> <span class="op">=</span><span class="op">&gt;</span> {<span class="number">5</span>},
	    <span class="string">&quot;IW&quot;</span> <span class="op">=</span><span class="op">&gt;</span> {<span class="number">3</span>},
	    <span class="kw">_</span> <span class="op">=</span><span class="op">&gt;</span> <span class="macro">panic</span><span class="macro">!</span>(<span class="string">&quot;Incorrect sentmode&quot;</span>)
	}
    }
}

<span class="attribute">#[<span class="ident">macro_use</span>]</span>
<span class="macro">macro_rules</span><span class="macro">!</span> <span class="ident">argmax_row</span> {
    (<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>:<span class="ident">expr</span>) <span class="op">=</span><span class="op">&gt;</span> {
	<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>().<span class="ident">fold</span>((<span class="number">0</span>, <span class="number">0.0</span>, <span class="bool-val">false</span>), <span class="op">|</span><span class="ident">acc</span>, <span class="ident">x</span><span class="op">|</span> {
	    <span class="kw">if</span> <span class="op">!</span><span class="ident">acc</span>.<span class="number">2</span> <span class="op">|</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span>.<span class="number">1</span> <span class="op">&gt;</span> <span class="ident">acc</span>.<span class="number">1</span> {<span class="kw">return</span> (<span class="ident">x</span>.<span class="number">0</span>,<span class="kw-2">*</span><span class="ident">x</span>.<span class="number">1</span>,<span class="bool-val">true</span>);}
	    <span class="ident">acc</span>
	})
    };
}
<span class="attribute">#[<span class="ident">macro_use</span>]</span>
<span class="macro">macro_rules</span><span class="macro">!</span> <span class="ident">argmin_row</span> {
    (<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>:<span class="ident">expr</span>) <span class="op">=</span><span class="op">&gt;</span> {
	<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>().<span class="ident">fold</span>((<span class="number">0</span>, <span class="number">0.0</span>, <span class="bool-val">false</span>), <span class="op">|</span><span class="ident">acc</span>, <span class="ident">x</span><span class="op">|</span> {
	    <span class="kw">if</span> <span class="op">!</span><span class="ident">acc</span>.<span class="number">2</span> <span class="op">|</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span>.<span class="number">1</span> <span class="op">&lt;</span> <span class="ident">acc</span>.<span class="number">1</span> {<span class="kw">return</span> (<span class="ident">x</span>.<span class="number">0</span>,<span class="kw-2">*</span><span class="ident">x</span>.<span class="number">1</span>,<span class="bool-val">true</span>);}
	    <span class="ident">acc</span>
	})
    };
}

<span class="macro">macro_rules</span><span class="macro">!</span> <span class="ident">unpack_bound</span> {
    (<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>:<span class="ident">expr</span>) <span class="op">=</span><span class="op">&gt;</span> {
	(<span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">fa</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">la</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">fr</span>, <span class="macro-nonterminal">$</span><span class="macro-nonterminal">sw</span>.<span class="ident">lr</span>)
    }
}


<span class="doccomment">/// Gets the clear midpoints.</span>
<span class="doccomment">/// eval: determines whether to do padded eval midpoints</span>
<span class="doccomment">/// Or just return the midpoints as is.</span>
<span class="kw">fn</span> <span class="ident">compute_midpoint</span>(<span class="ident">pat_angle</span>:<span class="kw-2">&amp;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>, <span class="ident">pat_vals</span>:<span class="kw-2">&amp;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>, <span class="ident">swath</span>:<span class="ident">usize</span>, <span class="ident">id</span>:<span class="kw-2">&amp;</span><span class="ident">SentinelFormatId</span>,
		    <span class="ident">eval</span>:<span class="ident">bool</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>{ 
    	    
    <span class="kw">match</span> <span class="ident">id</span>.<span class="ident">sentmode</span>.<span class="ident">as_str</span>() {
	<span class="string">&quot;EW&quot;</span> <span class="op">=</span><span class="op">&gt;</span> {
	    <span class="kw">match</span> <span class="ident">eval</span> {
		<span class="bool-val">true</span> <span class="op">=</span><span class="op">&gt;</span> {
		    <span class="kw">let</span> <span class="ident">offsets</span> <span class="op">=</span> <span class="kw-2">&amp;</span>[(<span class="op">-</span><span class="number">0.6</span>,<span class="number">0.6</span>), (<span class="op">-</span><span class="number">0.7</span>, <span class="number">1.0</span>), (<span class="op">-</span><span class="number">0.8</span>, <span class="number">0.8</span>), (<span class="op">-</span><span class="number">0.7</span>, <span class="number">0.8</span>), (<span class="op">-</span><span class="number">0.7</span>,<span class="number">0.9</span>)];
		    <span class="kw">if</span> <span class="ident">swath</span> <span class="op">=</span><span class="op">=</span> <span class="number">0</span> {
			<span class="kw">let</span> (<span class="ident">a</span>, <span class="ident">_am</span>, <span class="ident">_fa</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>);
			<span class="kw">let</span> (<span class="ident">b</span>, <span class="ident">_bm</span>, <span class="ident">_fb</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>[<span class="number">0</span>..<span class="ident">a</span><span class="op">/</span><span class="number">2</span>]);
			<span class="kw">let</span> (<span class="ident">c</span>, <span class="ident">_cm</span>, <span class="ident">_fc</span>) <span class="op">=</span> <span class="macro">argmin_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>[<span class="ident">b</span>..<span class="ident">a</span>]);
			
			<span class="comment">/*
			
			#midlist = [angles_list[b], angles_list[b+c], angles_list[a]]
			midlist = [angles_list[b], angles_list[b+c], angles_list[a]]*/</span>
			<span class="kw">return</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">pat_angle</span>[<span class="number">0</span>], <span class="ident">pat_angle</span>[<span class="ident">b</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="number">0</span>].<span class="number">0</span>,
				    <span class="ident">pat_angle</span>[<span class="ident">b</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="number">0</span>].<span class="number">1</span>, <span class="ident">pat_angle</span>[<span class="ident">b</span><span class="op">+</span><span class="ident">c</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="number">0</span>].<span class="number">0</span>,
				    <span class="ident">pat_angle</span>[<span class="ident">b</span><span class="op">+</span><span class="ident">c</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="number">0</span>].<span class="number">1</span>, <span class="ident">pat_angle</span>[<span class="ident">a</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="number">0</span>].<span class="number">0</span>,
				    <span class="ident">pat_angle</span>[<span class="ident">a</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="number">0</span>].<span class="number">1</span>, <span class="kw-2">*</span><span class="ident">pat_angle</span>.<span class="ident">last</span>().<span class="ident">unwrap</span>()
			];
		    }
		    <span class="kw">else</span> {
			<span class="kw">let</span> (<span class="ident">a</span>, <span class="ident">_am</span>, <span class="ident">_fa</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>);
			<span class="kw">return</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">pat_angle</span>[<span class="number">0</span>], <span class="ident">pat_angle</span>[<span class="ident">a</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="ident">swath</span>].<span class="number">0</span>,
				    <span class="ident">pat_angle</span>[<span class="ident">a</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="ident">swath</span>].<span class="number">1</span>, <span class="kw-2">*</span><span class="ident">pat_angle</span>.<span class="ident">last</span>().<span class="ident">unwrap</span>()
			];
		    }

		}
		<span class="bool-val">false</span> <span class="op">=</span><span class="op">&gt;</span> {
		    <span class="kw">if</span> <span class="ident">swath</span> <span class="op">=</span><span class="op">=</span> <span class="number">0</span> {
			<span class="kw">let</span> (<span class="ident">a</span>, <span class="ident">_am</span>, <span class="ident">_fa</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>);
			<span class="kw">let</span> (<span class="ident">b</span>, <span class="ident">_bm</span>, <span class="ident">_fb</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>[<span class="number">0</span>..<span class="ident">a</span><span class="op">/</span><span class="number">2</span>]);
			<span class="kw">let</span> (<span class="ident">c</span>, <span class="ident">_cm</span>, <span class="ident">_fc</span>) <span class="op">=</span> <span class="macro">argmin_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>[<span class="ident">b</span>..<span class="ident">a</span>]);

			<span class="kw">return</span> <span class="macro">vec</span><span class="macro">!</span>[(<span class="ident">pat_angle</span>[<span class="ident">b</span>]),
				    (<span class="ident">pat_angle</span>[<span class="ident">b</span><span class="op">+</span><span class="ident">c</span>]),
				    (<span class="ident">pat_angle</span>[<span class="ident">a</span>])];
		    }
		    <span class="kw">else</span> {
			<span class="kw">let</span> (<span class="ident">a</span>, <span class="ident">_am</span>, <span class="ident">_fa</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>);
			<span class="kw">return</span> <span class="macro">vec</span><span class="macro">!</span>[(<span class="ident">pat_angle</span>[<span class="ident">a</span>])];
		    }
		}
	    }
	},
	<span class="string">&quot;IW&quot;</span> <span class="op">=</span><span class="op">&gt;</span> {
	    <span class="kw">match</span> <span class="ident">eval</span> {
		<span class="bool-val">true</span> <span class="op">=</span><span class="op">&gt;</span> {
		    <span class="kw">let</span> <span class="ident">offsets</span> <span class="op">=</span> <span class="kw-2">&amp;</span>[(<span class="op">-</span><span class="number">1.0</span>,<span class="number">1.0</span>), (<span class="op">-</span><span class="number">1.0</span>,<span class="number">1.0</span>), (<span class="op">-</span><span class="number">1.0</span>,<span class="number">1.0</span>)];
		    <span class="kw">let</span> (<span class="ident">a</span>, <span class="ident">_am</span>, <span class="ident">_fa</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>);
		    <span class="kw">return</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">pat_angle</span>[<span class="number">0</span>], <span class="ident">pat_angle</span>[<span class="ident">a</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="ident">swath</span>].<span class="number">0</span>,
				<span class="ident">pat_angle</span>[<span class="ident">a</span>] <span class="op">+</span> <span class="ident">offsets</span>[<span class="ident">swath</span>].<span class="number">1</span>, <span class="kw-2">*</span><span class="ident">pat_angle</span>.<span class="ident">last</span>().<span class="ident">unwrap</span>()];
		}
		<span class="bool-val">false</span> <span class="op">=</span><span class="op">&gt;</span> {
		    <span class="kw">let</span> (<span class="ident">a</span>, <span class="ident">_am</span>, <span class="ident">_fa</span>) <span class="op">=</span> <span class="macro">argmax_row</span><span class="macro">!</span>(<span class="ident">pat_vals</span>);
		    <span class="kw">return</span> <span class="macro">vec</span><span class="macro">!</span>[(<span class="ident">pat_angle</span>[<span class="ident">a</span>])];
		}
	    }
	},
	<span class="kw">_</span> <span class="op">=</span><span class="op">&gt;</span> <span class="macro">panic</span><span class="macro">!</span>(<span class="string">&quot;Incorrect sentmode&quot;</span>)
    };
    
}

<span class="doccomment">/// Builds a quadratic spline to map angles to the index/intensity lookup table.</span>
<span class="doccomment">/// http://nmbooks.eng.usf.edu/ebooks/05inp_spline/inp_05_spline_300_quadratic_example.html</span>
<span class="doccomment">/// Computes splines that go through all the points and is first order derivative continuous.</span>
<span class="kw">fn</span> <span class="ident">quadratic_spline</span>(<span class="ident">x</span>:<span class="kw-2">&amp;</span>[<span class="ident">f64</span>], <span class="ident">y</span>:<span class="kw-2">&amp;</span>[<span class="ident">f64</span>]) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">ArrToArr</span> {
    <span class="comment">// We assume that x is sorted</span>
    <span class="kw">let</span> <span class="ident">x_c</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">x</span>.<span class="ident">to_vec</span>();
    <span class="kw">let</span> <span class="ident">num_segments</span> <span class="op">=</span> <span class="ident">x_c</span>.<span class="ident">len</span>()<span class="op">-</span><span class="number">1</span>;
    <span class="kw">let</span> <span class="ident">num_params</span> <span class="op">=</span> <span class="ident">num_segments</span> <span class="op">*</span> <span class="number">3</span>;
    
    <span class="comment">// Check sorted</span>

    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">num_segments</span> {
	<span class="macro">assert</span><span class="macro">!</span>(<span class="ident">x_c</span>[<span class="ident">i</span>] <span class="op">&lt;</span><span class="op">=</span> <span class="ident">x_c</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>]);
    }
    <span class="kw">let</span> <span class="ident">_k</span> <span class="op">=</span> <span class="number">2</span>;

    <span class="comment">// Going to set up a banded matrix to compute the coefficients of the matrix</span>
    <span class="comment">// This matrix is setup with 1 upper diagonal and 3 lower diagonals.</span>
    <span class="kw">let</span> <span class="ident">kl</span> <span class="op">=</span> <span class="number">3</span>;
    <span class="kw">let</span> <span class="ident">ku</span> <span class="op">=</span> <span class="number">1</span>;

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ab</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="number">0.0</span>;(<span class="number">2</span><span class="kw-2">*</span><span class="ident">kl</span><span class="op">+</span><span class="ident">ku</span><span class="op">+</span><span class="number">1</span>)<span class="kw-2">*</span><span class="ident">num_params</span>];
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">b</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="number">0.0</span>;<span class="ident">num_params</span>];
    
    <span class="comment">// set the first parameters.</span>
    <span class="ident">ab</span>[<span class="ident">kl</span><span class="op">+</span><span class="number">1</span>] <span class="op">=</span> <span class="number">1.0</span>; <span class="comment">//constraint for first point.</span>

    <span class="comment">// return col major index.</span>
    <span class="kw">let</span> <span class="ident">compute_ind</span> <span class="op">=</span> <span class="op">|</span><span class="ident">c</span>, <span class="ident">j</span><span class="op">|</span> <span class="op">-</span><span class="op">&gt;</span> <span class="ident">usize</span> {
	<span class="kw">let</span> <span class="ident">bi</span>:<span class="ident">isize</span> <span class="op">=</span> (<span class="ident">j</span> <span class="kw">as</span> <span class="ident">isize</span>) <span class="op">-</span> <span class="number">1</span>;
	<span class="kw">let</span> <span class="ident">l</span>:<span class="ident">usize</span> <span class="op">=</span> ((<span class="ident">c</span> <span class="kw">as</span> <span class="ident">isize</span>) <span class="op">-</span> <span class="ident">bi</span>) <span class="kw">as</span> <span class="ident">usize</span>;

	<span class="kw">let</span> <span class="ident">row</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="ident">kl</span> <span class="op">+</span><span class="ident">l</span>;

	<span class="ident">row</span> <span class="op">+</span> <span class="ident">j</span><span class="kw-2">*</span>(<span class="number">2</span><span class="kw-2">*</span><span class="ident">kl</span><span class="op">+</span><span class="ident">ku</span><span class="op">+</span><span class="number">1</span>)
	
    };

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">c</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="number">1</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">v</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="number">0</span>;
    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">num_segments</span><span class="op">-</span><span class="number">1</span> {
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">0</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span>]<span class="kw-2">*</span><span class="ident">x</span>[<span class="ident">i</span>];
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">1</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span>];
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">2</span>)] <span class="op">=</span> <span class="number">1.0</span>;

	<span class="ident">b</span>[<span class="ident">c</span>] <span class="op">=</span> <span class="ident">y</span>[<span class="ident">i</span>];
	<span class="ident">c</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;

	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">0</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>]<span class="kw-2">*</span><span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">1</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">2</span>)] <span class="op">=</span> <span class="number">1.0</span>;
	
	<span class="ident">b</span>[<span class="ident">c</span>] <span class="op">=</span> <span class="ident">y</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
	<span class="ident">c</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;

	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">0</span>)] <span class="op">=</span> <span class="number">2.0</span><span class="kw-2">*</span><span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">1</span>)] <span class="op">=</span> <span class="number">1.0</span>;
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">3</span><span class="op">+</span><span class="number">0</span>)] <span class="op">=</span> <span class="op">-</span><span class="number">2.0</span><span class="kw-2">*</span><span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
	<span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>,  <span class="ident">v</span><span class="op">+</span><span class="number">3</span><span class="op">+</span><span class="number">1</span>)] <span class="op">=</span> <span class="op">-</span><span class="number">1.0</span>;
	
	<span class="ident">b</span>[<span class="ident">c</span>] <span class="op">=</span> <span class="number">0.0</span>;
	<span class="ident">c</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;

	<span class="ident">v</span><span class="op">+</span><span class="op">=</span><span class="number">3</span>;
	
    }
    <span class="kw">let</span> <span class="ident">i</span> <span class="op">=</span> <span class="ident">num_segments</span><span class="op">-</span><span class="number">1</span>;
    <span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>, <span class="ident">v</span><span class="op">+</span><span class="number">0</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span>]<span class="kw-2">*</span><span class="ident">x</span>[<span class="ident">i</span>];
    <span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>, <span class="ident">v</span><span class="op">+</span><span class="number">1</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span>];
    <span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>, <span class="ident">v</span><span class="op">+</span><span class="number">2</span>)] <span class="op">=</span> <span class="number">1.0</span>;
  
    <span class="ident">b</span>[<span class="ident">c</span>] <span class="op">=</span> <span class="ident">y</span>[<span class="ident">i</span>];
    <span class="ident">c</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;
  
    <span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>, <span class="ident">v</span><span class="op">+</span><span class="number">0</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>]<span class="kw-2">*</span><span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
    <span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>, <span class="ident">v</span><span class="op">+</span><span class="number">1</span>)] <span class="op">=</span> <span class="ident">x</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
    <span class="ident">ab</span>[<span class="ident">compute_ind</span>(<span class="ident">c</span>, <span class="ident">v</span><span class="op">+</span><span class="number">2</span>)] <span class="op">=</span> <span class="number">1.0</span>;
    
    <span class="ident">b</span>[<span class="ident">c</span>] <span class="op">=</span> <span class="ident">y</span>[<span class="ident">i</span><span class="op">+</span><span class="number">1</span>];
    <span class="ident">c</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ipiv</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">i32</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="number">0</span>;<span class="ident">num_params</span>];
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">info</span>:<span class="ident">i32</span> <span class="op">=</span> <span class="number">0</span>;
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">c</span> <span class="op">=</span><span class="op">=</span> <span class="ident">num_params</span>);
    <span class="kw">unsafe</span> {
	<span class="ident">dgbsv</span>(<span class="ident">num_params</span> <span class="kw">as</span> <span class="ident">i32</span>,<span class="comment">// num eqs</span>
	      <span class="ident">kl</span> <span class="kw">as</span> <span class="ident">i32</span>,
	      <span class="ident">ku</span> <span class="kw">as</span> <span class="ident">i32</span>,
	      <span class="number">1</span>,<span class="comment">//num rows in b</span>
	      <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">ab</span>,
	      (<span class="number">2</span><span class="kw-2">*</span><span class="ident">kl</span><span class="op">+</span><span class="ident">ku</span><span class="op">+</span><span class="number">1</span>) <span class="kw">as</span> <span class="ident">i32</span>,
	      <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">ipiv</span>,
	      <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">b</span>,
	      <span class="ident">num_params</span> <span class="kw">as</span> <span class="ident">i32</span>,
	      <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">info</span>
	);
    }
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">info</span> <span class="op">=</span><span class="op">=</span> <span class="number">0</span>);


    <span class="kw">fn</span> <span class="ident">apply_quad</span>(<span class="ident">s</span>:<span class="ident">f64</span>, <span class="ident">coef</span>:(<span class="ident">f64</span>, <span class="ident">f64</span>, <span class="ident">f64</span>)) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">f64</span> {
	<span class="ident">coef</span>.<span class="number">0</span> <span class="op">+</span> <span class="ident">s</span><span class="kw-2">*</span><span class="ident">coef</span>.<span class="number">1</span> <span class="op">+</span> <span class="ident">s</span><span class="kw-2">*</span><span class="ident">s</span><span class="kw-2">*</span><span class="ident">coef</span>.<span class="number">2</span>
    }
    <span class="kw">let</span> <span class="ident">len_x</span> <span class="op">=</span> <span class="ident">x_c</span>.<span class="ident">len</span>();
    <span class="ident">Arc</span>::<span class="ident">new</span>(<span class="kw">move</span> <span class="op">|</span><span class="ident">cols</span>:<span class="kw-2">&amp;</span>[<span class="ident">usize</span>]<span class="op">|</span> <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span> {
	<span class="ident">cols</span>.<span class="ident">iter</span>().<span class="ident">map</span>(<span class="op">|</span><span class="ident">s_</span><span class="op">|</span> {
	    <span class="kw">let</span> <span class="ident">s</span> <span class="op">=</span> (<span class="kw-2">*</span><span class="ident">s_</span>) <span class="kw">as</span> <span class="ident">f64</span>;
	    <span class="kw">if</span> <span class="ident">s</span> <span class="op">&lt;</span><span class="op">=</span> <span class="ident">x_c</span>[<span class="number">0</span>] {<span class="ident">apply_quad</span>(<span class="ident">s</span>, (<span class="ident">b</span>[<span class="number">2</span>], <span class="ident">b</span>[<span class="number">1</span>], <span class="ident">b</span>[<span class="number">0</span>]))}
	    <span class="kw">else</span> <span class="kw">if</span> <span class="ident">s</span> <span class="op">&gt;</span><span class="op">=</span> <span class="ident">x_c</span>[<span class="ident">len_x</span><span class="op">-</span><span class="number">1</span>] {<span class="ident">apply_quad</span>(<span class="ident">s</span>, (<span class="ident">b</span>[<span class="ident">num_params</span><span class="op">-</span><span class="number">1</span>], <span class="ident">b</span>[<span class="ident">num_params</span><span class="op">-</span><span class="number">2</span>], <span class="ident">b</span>[<span class="ident">num_params</span><span class="op">-</span><span class="number">3</span>]))}
	    <span class="kw">else</span> {
		<span class="kw">match</span> <span class="ident">x_c</span>.<span class="ident">binary_search_by</span>(<span class="op">|</span><span class="ident">sd</span><span class="op">|</span> <span class="ident">sd</span>.<span class="ident">partial_cmp</span>(<span class="kw-2">&amp;</span><span class="ident">s</span>).<span class="ident">expect</span>(<span class="string">&quot;Nan encountered&quot;</span>) ) {
		    <span class="prelude-val">Ok</span>(<span class="ident">t</span>) <span class="op">=</span><span class="op">&gt;</span> <span class="ident">apply_quad</span>(<span class="ident">s</span>,(<span class="ident">b</span>[<span class="ident">t</span><span class="kw-2">*</span><span class="number">3</span><span class="op">+</span><span class="number">2</span>], <span class="ident">b</span>[<span class="ident">t</span><span class="kw-2">*</span><span class="number">3</span><span class="op">+</span><span class="number">1</span>], <span class="ident">b</span>[<span class="ident">t</span><span class="kw-2">*</span><span class="number">3</span>])),
		    <span class="prelude-val">Err</span>(<span class="ident">e</span>) <span class="op">=</span><span class="op">&gt;</span> <span class="ident">apply_quad</span>(<span class="ident">s</span>, (<span class="ident">b</span>[(<span class="ident">e</span><span class="op">-</span><span class="number">1</span>)<span class="kw-2">*</span><span class="number">3</span><span class="op">+</span><span class="number">2</span>], <span class="ident">b</span>[(<span class="ident">e</span><span class="op">-</span><span class="number">1</span>)<span class="kw-2">*</span><span class="number">3</span><span class="op">+</span><span class="number">1</span>], <span class="ident">b</span>[(<span class="ident">e</span><span class="op">-</span><span class="number">1</span>)<span class="kw-2">*</span><span class="number">3</span>]))
		}
	    }

	}).<span class="ident">collect</span>()
    })
    
    
}

<span class="kw">pub</span> <span class="kw">enum</span> <span class="ident">MidPoint</span> {
    <span class="ident">Est</span>(<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>),
    <span class="ident">Test</span>(<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">f64</span>,<span class="ident">f64</span>)<span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>),
}
<span class="doccomment">/// Returns a dictionary that provides the antenna values.</span>
<span class="doccomment">/// Along with indices of where to &quot;split&quot;</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">get_interpolation_pattern</span> (<span class="ident">_buffer</span>:<span class="kw-2">&amp;</span><span class="ident">str</span>,
				  <span class="ident">burst_coords</span>:<span class="kw-2">&amp;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">BurstEntry</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>,
				  <span class="ident">time_row_lut</span>:<span class="kw-2">&amp;</span><span class="ident">TimeRowLut</span>,
				  <span class="ident">pat_raw</span>:<span class="kw-2">&amp;</span><span class="ident">RawPattern</span>, <span class="ident">id</span>:<span class="kw-2">&amp;</span><span class="ident">SentinelFormatId</span>, <span class="ident">eval</span>:<span class="ident">bool</span>)
				  <span class="op">-</span><span class="op">&gt;</span> (<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">ArrToArr</span><span class="op">&gt;</span><span class="op">&gt;</span>, <span class="ident">MidPoint</span>) {
    <span class="kw">let</span> <span class="ident">_num_subswaths</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="macro">get_num_subswath</span><span class="macro">!</span>(<span class="ident">id</span>);

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mp_dict</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">ArrToArr</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>(); <span class="comment">// vector of closures for pattern value derivation</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">test_indices</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span>(<span class="ident">f64</span>,<span class="ident">f64</span>)<span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">est_indices</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();

    <span class="kw">for</span> (<span class="ident">swath</span>, <span class="ident">bu_co</span>) <span class="kw">in</span> <span class="ident">burst_coords</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>() {
	<span class="ident">mp_dict</span>.<span class="ident">push</span>(<span class="ident">Vec</span>::<span class="ident">new</span>());
	<span class="kw">match</span> <span class="ident">eval</span> {
	    <span class="bool-val">true</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">test_indices</span>.<span class="ident">push</span>(<span class="ident">Vec</span>::<span class="ident">new</span>()),
	    <span class="bool-val">false</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">est_indices</span>.<span class="ident">push</span>(<span class="ident">Vec</span>::<span class="ident">new</span>())
	}
	<span class="kw">for</span> (<span class="ident">n</span>, <span class="ident">burst</span>) <span class="kw">in</span> <span class="ident">bu_co</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>() {

	    <span class="comment">// Get raw pattern values.</span>
	    <span class="kw">let</span> <span class="ident">pat_angle</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">pat_raw</span>.<span class="ident">angle</span>[<span class="ident">swath</span>][<span class="ident">n</span>];
	    <span class="kw">let</span> <span class="ident">pat_vals</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">pat_raw</span>.<span class="ident">pattern</span>[<span class="ident">swath</span>][<span class="ident">n</span>];


	    <span class="comment">// get interp_model</span>
	    <span class="kw">let</span> <span class="ident">multi</span> <span class="op">=</span> <span class="ident">time_row_lut</span>.<span class="ident">interp_angle_to_col</span>();
	    
	    <span class="comment">// take the midrow as the one to use for interpolation</span>
	    <span class="kw">let</span> <span class="ident">mid_angles</span> <span class="op">=</span> <span class="ident">compute_midpoint</span>(<span class="ident">pat_angle</span>, <span class="ident">pat_vals</span>, <span class="ident">swath</span>, <span class="ident">id</span>, <span class="ident">eval</span>);
	    
	    <span class="kw">let</span> <span class="ident">row</span> <span class="op">=</span> (<span class="ident">burst</span>.<span class="ident">fa</span><span class="op">+</span><span class="ident">burst</span>.<span class="ident">la</span>)<span class="op">/</span><span class="number">2</span>;

	    <span class="kw">let</span> <span class="ident">pat_cols</span> <span class="op">=</span> <span class="ident">multi</span>(<span class="kw-2">&amp;</span><span class="ident">pat_angle</span>, <span class="ident">row</span>);

	    <span class="kw">let</span> <span class="ident">mp</span> <span class="op">=</span> <span class="ident">quadratic_spline</span>(<span class="kw-2">&amp;</span><span class="ident">pat_cols</span>, <span class="kw-2">&amp;</span><span class="ident">pat_vals</span>);

	    
	    <span class="ident">mp_dict</span>[<span class="ident">swath</span>].<span class="ident">push</span>(<span class="ident">mp</span>);

	    <span class="comment">// Match the midpoint formula according to evaluation or estimation.</span>
	    <span class="kw">match</span> <span class="ident">eval</span> {
		<span class="bool-val">true</span> <span class="op">=</span><span class="op">&gt;</span> {
		    <span class="kw">let</span> <span class="ident">t</span> <span class="op">=</span> <span class="ident">multi</span>(<span class="kw-2">&amp;</span><span class="ident">mid_angles</span>, <span class="ident">row</span>);
		    <span class="ident">test_indices</span>[<span class="ident">swath</span>].<span class="ident">push</span>(<span class="ident">Arc</span>::<span class="ident">new</span>(
					     <span class="ident">t</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>().<span class="ident">step_by</span>(<span class="number">2</span>).<span class="ident">map</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> (<span class="kw-2">*</span><span class="ident">x</span>.<span class="number">1</span>,<span class="ident">t</span>[<span class="ident">x</span>.<span class="number">0</span><span class="op">+</span><span class="number">1</span>])).<span class="ident">collect</span>()));
		}
		<span class="bool-val">false</span> <span class="op">=</span><span class="op">&gt;</span> {<span class="ident">est_indices</span>[<span class="ident">swath</span>].<span class="ident">push</span>(<span class="ident">Arc</span>::<span class="ident">new</span>(<span class="ident">multi</span>(<span class="kw-2">&amp;</span><span class="ident">mid_angles</span>, <span class="ident">row</span>)));}
	    }
	}
    }
    <span class="kw">let</span> <span class="ident">split_indices</span>:<span class="ident">MidPoint</span> <span class="op">=</span> <span class="kw">match</span> <span class="ident">eval</span> {
	<span class="bool-val">true</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">MidPoint</span>::<span class="ident">Test</span>(<span class="ident">test_indices</span>),
	<span class="bool-val">false</span> <span class="op">=</span><span class="op">&gt;</span> <span class="ident">MidPoint</span>::<span class="ident">Est</span>(<span class="ident">est_indices</span>)
    };
    (<span class="ident">mp_dict</span>, <span class="ident">split_indices</span>)
    
}



<span class="kw">fn</span> <span class="ident">compute_mean_slice</span>(<span class="ident">x</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">TwoDArray</span><span class="op">&gt;</span>, <span class="ident">swath_bounds</span>:<span class="ident">BurstEntry</span>)  <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">res</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="number">0.0</span>; <span class="ident">swath_bounds</span>.<span class="ident">lr</span> <span class="op">-</span> <span class="ident">swath_bounds</span>.<span class="ident">fr</span>];
    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="ident">swath_bounds</span>.<span class="ident">fr</span>..<span class="ident">swath_bounds</span>.<span class="ident">lr</span> {
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">cum_val</span> <span class="op">=</span> <span class="number">0.0</span>;
	<span class="kw">let</span> <span class="ident">norm</span> <span class="op">=</span> (<span class="ident">swath_bounds</span>.<span class="ident">la</span><span class="op">-</span><span class="ident">swath_bounds</span>.<span class="ident">fa</span>) <span class="kw">as</span> <span class="ident">f64</span>;
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">nonzero</span> <span class="op">=</span> <span class="bool-val">true</span>;
	<span class="kw">for</span> <span class="ident">j</span> <span class="kw">in</span> <span class="ident">swath_bounds</span>.<span class="ident">fa</span>..<span class="ident">swath_bounds</span>.<span class="ident">la</span> {
	    <span class="ident">nonzero</span> <span class="op">=</span> <span class="ident">nonzero</span> <span class="op">&amp;</span> (<span class="ident">x</span>[(<span class="ident">j</span>,<span class="ident">i</span>)] <span class="op">!</span><span class="op">=</span> <span class="number">0.0</span>);
	    <span class="ident">cum_val</span> <span class="op">+</span><span class="op">=</span> <span class="ident">x</span>[(<span class="ident">j</span>,<span class="ident">i</span>)].<span class="ident">max</span>(<span class="number">0.0</span>)<span class="op">/</span><span class="ident">norm</span>;
	}
	<span class="kw">if</span> <span class="ident">nonzero</span> {
	    <span class="ident">res</span>[<span class="ident">i</span><span class="op">-</span><span class="ident">swath_bounds</span>.<span class="ident">fr</span>] <span class="op">=</span> <span class="ident">cum_val</span>;
	}
    }
    <span class="ident">res</span>
}

<span class="doccomment">/// Performs boxcar smoothing on the entry via FFT.</span>
<span class="kw">fn</span> <span class="ident">boxcar</span>(<span class="ident">sl</span>:<span class="kw-2">&amp;</span>[<span class="ident">f64</span>], <span class="ident">hyper</span>:<span class="kw-2">&amp;</span><span class="ident">HyperParams</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span> {

    <span class="comment">// get input data prepared</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">sl_r</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Complex64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">sl</span>.<span class="ident">iter</span>().<span class="ident">map</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="kw-2">*</span><span class="ident">x</span><span class="op">/</span>(<span class="ident">sl</span>.<span class="ident">len</span>() <span class="kw">as</span> <span class="ident">f64</span>), <span class="number">0.0</span>)).<span class="ident">collect</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">f_sl_r</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Complex64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="number">0.0</span>,<span class="number">0.0</span>); <span class="ident">sl</span>.<span class="ident">len</span>()];
    
    <span class="comment">// Construct box filter</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">box_f</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Complex64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="number">0.0</span>,<span class="number">0.0</span>); <span class="ident">sl</span>.<span class="ident">len</span>()];
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">f_box_f</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Complex64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="number">0.0</span>,<span class="number">0.0</span>); <span class="ident">sl</span>.<span class="ident">len</span>()];
    <span class="comment">//let a = &amp;mut box_f[0..hyper.box_l/2+1];</span>
    <span class="ident">box_f</span>[<span class="number">0</span>..<span class="ident">hyper</span>.<span class="ident">box_l</span><span class="op">/</span><span class="number">2</span><span class="op">+</span><span class="number">1</span>].<span class="ident">iter_mut</span>().<span class="ident">for_each</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">=</span> <span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="number">1.0</span><span class="op">/</span>(<span class="ident">hyper</span>.<span class="ident">box_l</span> <span class="kw">as</span> <span class="ident">f64</span>), <span class="number">0.0</span>));

    <span class="ident">box_f</span>[<span class="ident">sl</span>.<span class="ident">len</span>()<span class="op">-</span><span class="ident">hyper</span>.<span class="ident">box_l</span><span class="op">/</span><span class="number">2</span>..<span class="ident">sl</span>.<span class="ident">len</span>()].<span class="ident">iter_mut</span>().<span class="ident">for_each</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">=</span> <span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="number">1.0</span><span class="op">/</span>(<span class="ident">hyper</span>.<span class="ident">box_l</span> <span class="kw">as</span> <span class="ident">f64</span>),<span class="number">0.0</span>));

    <span class="comment">// Get the FFT stuff ready</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">f_planner</span> <span class="op">=</span> <span class="ident">FFTplanner</span>::<span class="ident">new</span>(<span class="bool-val">false</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">i_planner</span> <span class="op">=</span> <span class="ident">FFTplanner</span>::<span class="ident">new</span>(<span class="bool-val">true</span>);

    <span class="kw">let</span> <span class="ident">fft</span> <span class="op">=</span> <span class="ident">f_planner</span>.<span class="ident">plan_fft</span>(<span class="ident">sl</span>.<span class="ident">len</span>());
    <span class="kw">let</span> <span class="ident">ifft</span> <span class="op">=</span> <span class="ident">i_planner</span>.<span class="ident">plan_fft</span>(<span class="ident">sl</span>.<span class="ident">len</span>());

    <span class="comment">// Apply fft</span>
    <span class="ident">fft</span>.<span class="ident">process</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">box_f</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">f_box_f</span>);
    <span class="ident">fft</span>.<span class="ident">process</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">sl_r</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">f_sl_r</span>);

    <span class="comment">//Apply convolution</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">f_res</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Complex64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">f_box_f</span>.<span class="ident">iter</span>().<span class="ident">zip</span>(<span class="ident">f_sl_r</span>.<span class="ident">iter</span>()).<span class="ident">map</span>(
	<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="ident">x</span>.<span class="number">0</span><span class="kw-2">*</span><span class="ident">x</span>.<span class="number">1</span>).<span class="ident">collect</span>();

    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">res</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Complex64</span><span class="op">&gt;</span> <span class="op">=</span> <span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Complex64</span>::<span class="ident">new</span>(<span class="number">0.0</span>,<span class="number">0.0</span>); <span class="ident">sl</span>.<span class="ident">len</span>()];
    <span class="comment">// apply inverse fft</span>
    <span class="ident">ifft</span>.<span class="ident">process</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">f_res</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">res</span>);
    
    <span class="comment">// Finally convert values back to f64.</span>
    <span class="ident">res</span>.<span class="ident">iter</span>().<span class="ident">map</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="ident">x</span>.<span class="ident">re</span>).<span class="ident">collect</span>()

    
}

<span class="kw">type</span> <span class="ident">EstSegment</span> <span class="op">=</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span>;
<span class="kw">fn</span> <span class="ident">process_segment</span>(<span class="ident">x</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">TwoDArray</span><span class="op">&gt;</span>, <span class="ident">burst_coords</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">BurstEntry</span><span class="op">&gt;</span>, <span class="ident">swath</span>:<span class="ident">usize</span>, <span class="ident">ant</span>:<span class="ident">ArrToArr</span>,
		   <span class="ident">split_index</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span>, <span class="ident">o_value</span>:<span class="ident">f64</span>, <span class="ident">hyper</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">HyperParams</span><span class="op">&gt;</span> ) <span class="op">-</span><span class="op">&gt;</span> (<span class="ident">EstSegment</span>, <span class="ident">EstSegment</span>){
    <span class="kw">let</span> <span class="ident">padding</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="ident">hyper</span>.<span class="ident">burst_padding</span>;
    <span class="kw">let</span> <span class="ident">num_subswaths</span> <span class="op">=</span> <span class="number">5</span>; <span class="comment">// TODO: fix</span>

    <span class="comment">// Get mean value</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">sl</span> <span class="op">=</span> <span class="ident">compute_mean_slice</span>(<span class="ident">x</span>, <span class="ident">BurstEntry</span>{
	<span class="ident">fa</span>:<span class="ident">burst_coords</span>.<span class="ident">fa</span> <span class="op">+</span> <span class="ident">padding</span>,
	<span class="ident">la</span>:<span class="ident">burst_coords</span>.<span class="ident">la</span> <span class="op">-</span> <span class="ident">padding</span> <span class="op">+</span> <span class="number">1</span> ,
	<span class="ident">fr</span>:<span class="ident">burst_coords</span>.<span class="ident">fr</span> <span class="op">+</span> <span class="ident">padding</span>,
	<span class="ident">lr</span>:<span class="ident">burst_coords</span>.<span class="ident">lr</span> <span class="op">-</span> <span class="ident">padding</span> <span class="op">+</span> <span class="number">1</span>});
    <span class="comment">// ensure that values are above 0</span>
    <span class="ident">sl</span>.<span class="ident">iter_mut</span>().<span class="ident">for_each</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw">if</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">&lt;</span> <span class="number">0.0</span> { <span class="kw-2">*</span><span class="ident">x</span> <span class="op">=</span> <span class="number">0.0</span>;});

    <span class="comment">// get zero mask to remove the low values that were convolved.</span>
    <span class="kw">let</span> <span class="ident">zero_mask</span> <span class="op">=</span> <span class="ident">sl</span>.<span class="ident">iter</span>().<span class="ident">map</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">&lt;</span><span class="op">=</span> <span class="number">0.0</span>);
    <span class="comment">// get filtered slice</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">filt_sl</span> <span class="op">=</span> <span class="ident">boxcar</span>(<span class="kw-2">&amp;</span><span class="ident">sl</span>, <span class="kw-2">&amp;</span><span class="ident">hyper</span>);
    <span class="comment">// rezero the appropriate entries</span>
    <span class="comment">// (this ensures we don&#39;t get weird drops in output that inhibit LP estimation)</span>
    <span class="ident">filt_sl</span>.<span class="ident">iter_mut</span>().<span class="ident">zip</span>(<span class="ident">zero_mask</span>).<span class="ident">for_each</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw">if</span> <span class="ident">x</span>.<span class="number">1</span> {<span class="kw-2">*</span><span class="ident">x</span>.<span class="number">0</span> <span class="op">=</span> <span class="number">0.0</span>});

    <span class="kw">let</span> <span class="ident">len_filt</span> <span class="op">=</span> <span class="ident">filt_sl</span>.<span class="ident">len</span>();
    <span class="comment">// next, zero out the weird values on the edges</span>
    <span class="kw">if</span> <span class="ident">swath</span> <span class="op">=</span><span class="op">=</span> <span class="number">0</span> { <span class="comment">// note, this is redundant, but I&#39;m keeping it bc it was in the python code</span>
	<span class="ident">filt_sl</span>[<span class="number">0</span>..<span class="number">25</span>].<span class="ident">iter_mut</span>().<span class="ident">for_each</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">=</span> <span class="number">0.0</span>);
    }

    <span class="kw">else</span> <span class="kw">if</span> <span class="ident">swath</span> <span class="op">=</span><span class="op">=</span> <span class="ident">num_subswaths</span> <span class="op">-</span> <span class="number">1</span> {
	<span class="ident">filt_sl</span>[<span class="ident">len_filt</span><span class="op">-</span><span class="number">70</span>..].<span class="ident">iter_mut</span>().<span class="ident">for_each</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">=</span> <span class="number">0.0</span>);
    }

    <span class="comment">// Now find out where to amputate</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mn</span> <span class="op">=</span> <span class="number">10000</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mnfound</span> <span class="op">=</span> <span class="bool-val">false</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mxfound</span> <span class="op">=</span> <span class="bool-val">false</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mx</span> <span class="op">=</span> <span class="number">0</span>;
    <span class="kw">for</span> (<span class="ident">e</span>,<span class="ident">x</span>) <span class="kw">in</span> <span class="ident">filt_sl</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>() {
	<span class="kw">if</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">!</span><span class="op">=</span> <span class="number">0.0</span> { <span class="ident">mn</span> <span class="op">=</span> <span class="ident">e</span>; <span class="ident">mnfound</span> <span class="op">=</span> <span class="bool-val">true</span>; <span class="kw">break</span>;}
    }
    <span class="kw">for</span> (<span class="ident">e</span>,<span class="ident">x</span>) <span class="kw">in</span> <span class="ident">filt_sl</span>.<span class="ident">iter</span>().<span class="ident">enumerate</span>() {
	<span class="kw">if</span> <span class="kw-2">*</span><span class="ident">x</span> <span class="op">!</span><span class="op">=</span> <span class="number">0.0</span> { <span class="ident">mx</span> <span class="op">=</span> <span class="ident">e</span>; <span class="ident">mxfound</span> <span class="op">=</span> <span class="bool-val">true</span>; }
    }
    <span class="kw">if</span> <span class="op">!</span><span class="ident">mnfound</span>  <span class="op">|</span><span class="op">|</span> <span class="op">!</span><span class="ident">mxfound</span> <span class="op">|</span><span class="op">|</span> (<span class="ident">mn</span> <span class="op">+</span> <span class="number">25</span> <span class="op">&gt;</span> <span class="ident">mx</span> <span class="op">-</span> <span class="number">25</span>) { <span class="ident">mn</span> <span class="op">=</span> <span class="number">0</span>; <span class="ident">mx</span> <span class="op">=</span> <span class="number">50</span>}

    <span class="ident">filt_sl</span> <span class="op">=</span> <span class="ident">filt_sl</span>[<span class="ident">mn</span><span class="op">+</span><span class="number">25</span>..<span class="ident">mx</span><span class="op">-</span><span class="number">25</span>].<span class="ident">to_vec</span>();

    <span class="comment">// Finally, return the segments divided by the bursts</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ln_real_list</span>:<span class="ident">EstSegment</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ln_ant_list</span>:<span class="ident">EstSegment</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
    
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">prev</span>:<span class="ident">usize</span>;
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">nex</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="number">0</span>;
    <span class="kw">let</span> <span class="ident">fr</span> <span class="op">=</span> <span class="ident">burst_coords</span>.<span class="ident">fr</span> <span class="op">+</span> <span class="ident">padding</span> <span class="op">+</span> <span class="ident">mn</span> <span class="op">+</span> <span class="number">25</span>;

    <span class="comment">// PRocess log segment</span>
    <span class="kw">fn</span> <span class="ident">get_seg</span>(<span class="ident">prev</span>:<span class="ident">usize</span>, <span class="ident">nex</span>:<span class="ident">usize</span>, <span class="ident">filt_sl</span>:<span class="kw-2">&amp;</span>[<span class="ident">f64</span>], <span class="ident">antvals</span>:<span class="kw-2">&amp;</span>[<span class="ident">f64</span>], <span class="ident">o_value</span>:<span class="ident">f64</span>) <span class="op">-</span><span class="op">&gt;</span> (<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>, <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span>){
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">lreal</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">lant</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
	
	<span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="ident">prev</span>..<span class="ident">nex</span> {
	    <span class="kw">if</span> <span class="ident">filt_sl</span>[<span class="ident">i</span>]<span class="op">-</span><span class="ident">o_value</span> <span class="op">&lt;</span><span class="op">=</span> <span class="number">0.0</span> {<span class="kw">continue</span>;}
	    <span class="ident">lreal</span>.<span class="ident">push</span>((<span class="ident">filt_sl</span>[<span class="ident">i</span>]<span class="op">-</span><span class="ident">o_value</span>).<span class="ident">ln</span>());
	    <span class="ident">lant</span>.<span class="ident">push</span>(<span class="ident">antvals</span>[<span class="ident">i</span>].<span class="ident">ln</span>());
	}

	(<span class="ident">lreal</span>, <span class="ident">lant</span>)
    }
    <span class="kw">let</span> <span class="ident">inds</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">usize</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="ident">fr</span>..<span class="ident">fr</span><span class="op">+</span><span class="ident">filt_sl</span>.<span class="ident">len</span>()).<span class="ident">collect</span>();
    <span class="kw">let</span> <span class="ident">ant_vals</span> <span class="op">=</span> <span class="ident">ant</span>(<span class="kw-2">&amp;</span><span class="ident">inds</span>);
    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">split_index</span>.<span class="ident">len</span>() {
	<span class="ident">prev</span> <span class="op">=</span> <span class="ident">nex</span> <span class="op">+</span> <span class="number">2</span><span class="kw-2">*</span><span class="ident">hyper</span>.<span class="ident">add_pad</span>;
	<span class="ident">nex</span> <span class="op">=</span> (<span class="ident">split_index</span>[<span class="ident">i</span>].<span class="ident">round</span>() <span class="kw">as</span> <span class="ident">usize</span> <span class="op">-</span> <span class="ident">fr</span>) <span class="kw">as</span> <span class="ident">usize</span> <span class="op">-</span> <span class="ident">hyper</span>.<span class="ident">add_pad</span>;
	
	<span class="kw">let</span> (<span class="ident">real</span>, <span class="ident">ant</span>) <span class="op">=</span> <span class="ident">get_seg</span>(<span class="ident">prev</span>, <span class="ident">nex</span>.<span class="ident">min</span>(<span class="ident">filt_sl</span>.<span class="ident">len</span>()), <span class="kw-2">&amp;</span><span class="ident">filt_sl</span>, <span class="kw-2">&amp;</span><span class="ident">ant_vals</span>, <span class="ident">o_value</span>);
	<span class="ident">ln_real_list</span>.<span class="ident">push</span>(<span class="ident">real</span>);
	<span class="ident">ln_ant_list</span>.<span class="ident">push</span>(<span class="ident">ant</span>);
    }
    <span class="comment">// final segment.</span>
    <span class="ident">prev</span> <span class="op">=</span> <span class="ident">nex</span> <span class="op">+</span> <span class="number">2</span><span class="kw-2">*</span><span class="ident">hyper</span>.<span class="ident">add_pad</span>;
    <span class="ident">nex</span> <span class="op">=</span> <span class="ident">filt_sl</span>.<span class="ident">len</span>();
    <span class="kw">let</span> (<span class="ident">real</span>, <span class="ident">ant</span>) <span class="op">=</span> <span class="ident">get_seg</span>(<span class="ident">prev</span>, <span class="ident">nex</span>, <span class="kw-2">&amp;</span><span class="ident">filt_sl</span>, <span class="kw-2">&amp;</span><span class="ident">ant_vals</span>, <span class="ident">o_value</span>);
    <span class="ident">ln_real_list</span>.<span class="ident">push</span>(<span class="ident">real</span>);
    <span class="ident">ln_ant_list</span>.<span class="ident">push</span>(<span class="ident">ant</span>);

    (<span class="ident">ln_real_list</span>, <span class="ident">ln_ant_list</span>)
    
    
}

<span class="doccomment">/// Processes the segments in the splits/ bursts and</span>
<span class="doccomment">/// returns the slope/intercept parameters for each slope.</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">select_and_estimate_segments</span>(<span class="ident">x</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">TwoDArray</span><span class="op">&gt;</span>, <span class="ident">mp_dict</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">ArrToArr</span><span class="op">&gt;</span><span class="op">&gt;</span>,
				    <span class="ident">burst_coords</span>:<span class="kw-2">&amp;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">BurstEntry</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>,
				    <span class="ident">split_indices</span>:<span class="kw-2">&amp;</span><span class="ident">MidPoint</span>,
				    <span class="ident">o_list</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span>,
				    <span class="ident">hyper</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">HyperParams</span><span class="op">&gt;</span>,
				    <span class="ident">id</span>:<span class="kw-2">&amp;</span><span class="ident">SentinelFormatId</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="kw">crate</span>::<span class="ident">est_lp</span>::<span class="ident">lin_params</span><span class="op">&gt;</span><span class="op">&gt;</span>{
    <span class="kw">let</span> <span class="ident">num_subswaths</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="macro">get_num_subswath</span><span class="macro">!</span>(<span class="ident">id</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">ret</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="kw">crate</span>::<span class="ident">est_lp</span>::<span class="ident">lin_params</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">with_capacity</span>(<span class="ident">num_subswaths</span>);
    <span class="kw">match</span> <span class="ident">split_indices</span> {
	<span class="ident">MidPoint</span>::<span class="ident">Est</span>(<span class="ident">splitind</span>) <span class="op">=</span><span class="op">&gt;</span> {
	    <span class="kw">for</span> <span class="ident">swath</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">num_subswaths</span> {
		<span class="kw">let</span> <span class="ident">n_splits</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="ident">splitind</span>[<span class="ident">swath</span>][<span class="number">0</span>].<span class="ident">len</span>() <span class="op">+</span> <span class="number">1</span>;
		<span class="kw">let</span> <span class="ident">lreal</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Mutex</span><span class="op">&lt;</span><span class="ident">EstSegment</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Arc</span>::<span class="ident">new</span>(<span class="ident">Mutex</span>::<span class="ident">new</span>(<span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Vec</span>::<span class="ident">new</span>();<span class="ident">n_splits</span>]));
		<span class="kw">let</span> <span class="ident">lant</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Mutex</span><span class="op">&lt;</span><span class="ident">EstSegment</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Arc</span>::<span class="ident">new</span>(<span class="ident">Mutex</span>::<span class="ident">new</span>(<span class="macro">vec</span><span class="macro">!</span>[<span class="ident">Vec</span>::<span class="ident">new</span>();<span class="ident">n_splits</span>]));

		<span class="comment">/* Prepare threads for gathering segments. */</span>
		<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">thread_handles</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="kw">_</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="number">2</span>..<span class="ident">burst_coords</span>[<span class="ident">swath</span>].<span class="ident">len</span>()).<span class="ident">map</span>(
		    <span class="op">|</span><span class="ident">e</span><span class="op">|</span> { <span class="comment">/* Clone reference counters.*/</span>
			<span class="kw">let</span> <span class="ident">x_</span> <span class="op">=</span> <span class="ident">x</span>.<span class="ident">clone</span>();
			<span class="kw">let</span> <span class="ident">hyper_</span> <span class="op">=</span> <span class="ident">hyper</span>.<span class="ident">clone</span>();
			<span class="kw">let</span> <span class="ident">burst</span> <span class="op">=</span> <span class="ident">burst_coords</span>[<span class="ident">swath</span>][<span class="ident">e</span>].<span class="ident">clone</span>();
			<span class="kw">let</span> <span class="ident">o</span> <span class="op">=</span> <span class="ident">o_list</span>[<span class="ident">swath</span>][<span class="ident">e</span>];
			<span class="kw">let</span> <span class="ident">_lreal</span> <span class="op">=</span>  <span class="ident">lreal</span>.<span class="ident">clone</span>();
			<span class="kw">let</span> <span class="ident">_lant</span> <span class="op">=</span> <span class="ident">lant</span>.<span class="ident">clone</span>();
			<span class="kw">let</span> <span class="ident">mp</span> <span class="op">=</span> <span class="ident">mp_dict</span>[<span class="ident">swath</span>][<span class="ident">e</span>].<span class="ident">clone</span>();
			<span class="kw">let</span> <span class="ident">sind</span> <span class="op">=</span> <span class="ident">splitind</span>[<span class="ident">swath</span>][<span class="ident">e</span>].<span class="ident">clone</span>();
			<span class="ident">thread</span>::<span class="ident">spawn</span>(<span class="kw">move</span> <span class="op">|</span><span class="op">|</span> {
			    <span class="kw">let</span> (<span class="kw-2">mut</span> <span class="ident">real</span>, <span class="kw-2">mut</span> <span class="ident">ant</span>) <span class="op">=</span> <span class="ident">process_segment</span>(<span class="ident">x_</span>, <span class="ident">burst</span>, <span class="ident">swath</span>, <span class="ident">mp</span>, <span class="ident">sind</span>, <span class="ident">o</span>, <span class="ident">hyper_</span>);
			    <span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> (<span class="number">0</span>..<span class="ident">n_splits</span>).<span class="ident">rev</span>() {
				{ <span class="comment">// This will ensure both aspects are locked until mutation is finished.</span>
				    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">zd</span> <span class="op">=</span> <span class="ident">_lreal</span>.<span class="ident">lock</span>().<span class="ident">unwrap</span>();
				    <span class="ident">zd</span>[<span class="ident">i</span>].<span class="ident">extend</span>(<span class="ident">real</span>.<span class="ident">pop</span>().<span class="ident">unwrap</span>());
				    <span class="ident">_lant</span>.<span class="ident">lock</span>().<span class="ident">unwrap</span>()[<span class="ident">i</span>].<span class="ident">extend</span>(<span class="ident">ant</span>.<span class="ident">pop</span>().<span class="ident">unwrap</span>());
				}
			    }
			})
		    }).<span class="ident">collect</span>();

		<span class="comment">/* Run the threads */</span>
		<span class="kw">let</span> <span class="ident">b</span> <span class="op">=</span> <span class="ident">thread_handles</span>.<span class="ident">len</span>();
		<span class="kw">for</span> <span class="ident">_i</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">b</span> {<span class="ident">thread_handles</span>.<span class="ident">pop</span>().<span class="ident">unwrap</span>().<span class="ident">join</span>().<span class="ident">unwrap</span>();}

		<span class="comment">/* Calculate the parameters via linear programming. */</span>
		<span class="ident">ret</span>.<span class="ident">push</span>(
		    <span class="ident">lreal</span>.<span class="ident">lock</span>().<span class="ident">unwrap</span>().<span class="ident">iter</span>()
			.<span class="ident">zip</span>(<span class="ident">lant</span>.<span class="ident">lock</span>().<span class="ident">unwrap</span>().<span class="ident">iter</span>())
			.<span class="ident">map</span>(<span class="op">|</span><span class="ident">x</span><span class="op">|</span> <span class="kw">crate</span>::<span class="ident">est_lp</span>::<span class="ident">solve_lp</span>(<span class="kw-2">&amp;</span><span class="ident">x</span>.<span class="number">0</span>, <span class="kw-2">&amp;</span><span class="ident">x</span>.<span class="number">1</span>, <span class="ident">hyper</span>.<span class="ident">clone</span>())).<span class="ident">collect</span>());
		
	    }
	}
	<span class="ident">MidPoint</span>::<span class="ident">Test</span>(<span class="kw">_</span>) <span class="op">=</span><span class="op">&gt;</span> <span class="macro">panic</span><span class="macro">!</span>(<span class="string">&quot;Wrong midpoints for estimation.&quot;</span>)
    }
    <span class="kw">return</span> <span class="ident">ret</span>;
}
<span class="comment">//https://cvxopt.org/userguide/coneprog.html#cvxopt.solvers.lp</span>



<span class="kw">fn</span> <span class="ident">determine_mino_value</span>(<span class="ident">base</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">TwoDArray</span><span class="op">&gt;</span>,
			<span class="ident">fa</span>:<span class="ident">usize</span>,
			<span class="ident">la</span>:<span class="ident">usize</span>,
			<span class="ident">fr</span>:<span class="ident">usize</span>,
			<span class="ident">lr</span>:<span class="ident">usize</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">f64</span>
{
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">minval</span>:<span class="ident">f64</span> <span class="op">=</span> <span class="number">99999999999.0</span>;
    <span class="kw">for</span> <span class="ident">j</span> <span class="kw">in</span> <span class="ident">fr</span>..<span class="ident">lr</span> {
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">cur</span> <span class="op">=</span> <span class="number">0.0</span>;
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">count</span> <span class="op">=</span> <span class="number">0</span>;
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">nonzero</span> <span class="op">=</span> <span class="bool-val">true</span>;
	<span class="kw">for</span> <span class="ident">i</span> <span class="kw">in</span> <span class="ident">fa</span>..<span class="ident">la</span> {
	    <span class="ident">nonzero</span> <span class="op">=</span> <span class="ident">nonzero</span> <span class="op">&amp;</span> (<span class="ident">base</span>[(<span class="ident">i</span>,<span class="ident">j</span>)] <span class="op">!</span><span class="op">=</span> <span class="number">0.0</span>);
	    <span class="ident">cur</span> <span class="op">+</span><span class="op">=</span> <span class="ident">base</span>[(<span class="ident">i</span>,<span class="ident">j</span>)];
	    <span class="ident">count</span><span class="op">+</span><span class="op">=</span><span class="number">1</span>;
	}
	<span class="kw">if</span> <span class="ident">nonzero</span> <span class="kw-2">&amp;</span><span class="op">&amp;</span> <span class="ident">cur</span> <span class="op">&gt;</span> <span class="number">0.0</span> {
	    <span class="ident">minval</span> <span class="op">=</span> <span class="ident">minval</span>.<span class="ident">min</span>(<span class="ident">cur</span><span class="op">/</span>(<span class="ident">count</span> <span class="kw">as</span> <span class="ident">f64</span>));
	}
    }
    <span class="ident">minval</span>

}
<span class="doccomment">/// Compute the minimum available value from the baseline reference (i.e. default ESA result)</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">compute_mino_list</span>(<span class="ident">base</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">TwoDArray</span><span class="op">&gt;</span>,
			 <span class="ident">burst_coords</span>:<span class="kw-2">&amp;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">BurstEntry</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span>,
			 <span class="ident">hyper</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">HyperParams</span><span class="op">&gt;</span>,
			 <span class="ident">id</span>:<span class="kw-2">&amp;</span><span class="ident">SentinelFormatId</span>) <span class="op">-</span><span class="op">&gt;</span> <span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="ident">padding</span> <span class="op">=</span> <span class="ident">hyper</span>.<span class="ident">burst_padding</span>;
    <span class="kw">let</span> <span class="ident">num_subswaths</span>:<span class="ident">usize</span> <span class="op">=</span> <span class="macro">get_num_subswath</span><span class="macro">!</span>(<span class="ident">id</span>);
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">mino_list</span>:<span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();


    <span class="kw">for</span> <span class="ident">swath</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">num_subswaths</span> {
	<span class="kw">let</span> <span class="ident">tmp</span>:<span class="ident">Arc</span><span class="op">&lt;</span><span class="ident">Mutex</span><span class="op">&lt;</span><span class="ident">Vec</span><span class="op">&lt;</span><span class="ident">f64</span><span class="op">&gt;</span><span class="op">&gt;</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">Arc</span>::<span class="ident">new</span>(<span class="ident">Mutex</span>::<span class="ident">new</span>(<span class="macro">vec</span><span class="macro">!</span>[<span class="number">9999.0</span>;<span class="ident">burst_coords</span>[<span class="ident">swath</span>].<span class="ident">len</span>()]));
	<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">handles</span> <span class="op">=</span> <span class="ident">Vec</span>::<span class="ident">new</span>();
	<span class="kw">for</span> <span class="ident">c</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">burst_coords</span>[<span class="ident">swath</span>].<span class="ident">len</span>() {
	    <span class="kw">let</span> <span class="ident">bt</span> <span class="op">=</span> <span class="ident">burst_coords</span>[<span class="ident">swath</span>][<span class="ident">c</span>].<span class="ident">clone</span>();
	    <span class="kw">let</span> <span class="ident">tmp_</span> <span class="op">=</span> <span class="ident">tmp</span>.<span class="ident">clone</span>();
	    <span class="kw">let</span> <span class="ident">base__</span> <span class="op">=</span> <span class="ident">base</span>.<span class="ident">clone</span>();

	    <span class="ident">handles</span>.<span class="ident">push</span>(<span class="ident">thread</span>::<span class="ident">spawn</span>(<span class="kw">move</span> <span class="op">|</span><span class="op">|</span> {
	    	<span class="kw">let</span> (<span class="ident">fa_</span>, <span class="ident">la_</span>, <span class="ident">fr_</span>, <span class="ident">lr_</span> ) <span class="op">=</span> <span class="macro">unpack_bound</span><span class="macro">!</span>(<span class="ident">bt</span>);
	    	<span class="kw">let</span> <span class="ident">fa</span> <span class="op">=</span> <span class="ident">fa_</span> <span class="op">+</span> <span class="ident">padding</span>;
	    	<span class="kw">let</span> <span class="ident">la</span> <span class="op">=</span> <span class="ident">la_</span> <span class="op">-</span> <span class="ident">padding</span> <span class="op">+</span> <span class="number">1</span>;
	    	<span class="kw">let</span> <span class="ident">fr</span> <span class="op">=</span> <span class="ident">fr_</span> <span class="op">+</span> <span class="ident">padding</span>;
	    	<span class="kw">let</span> <span class="ident">lr</span> <span class="op">=</span> <span class="ident">lr_</span> <span class="op">-</span> <span class="ident">padding</span> <span class="op">+</span> <span class="number">1</span>;

	    	<span class="kw">let</span> <span class="ident">mino</span> <span class="op">=</span> <span class="ident">determine_mino_value</span>(<span class="ident">base__</span>,
	    					<span class="ident">fa</span>,<span class="ident">la</span>,<span class="ident">fr</span>,<span class="ident">lr</span>);
	    	<span class="ident">tmp_</span>.<span class="ident">lock</span>().<span class="ident">unwrap</span>()[<span class="ident">c</span>] <span class="op">=</span> <span class="ident">mino</span>;
	    }));

	}
	<span class="kw">let</span> <span class="ident">b</span> <span class="op">=</span> <span class="ident">handles</span>.<span class="ident">len</span>();
	<span class="kw">for</span> <span class="ident">_i</span> <span class="kw">in</span> <span class="number">0</span>..<span class="ident">b</span> {<span class="ident">handles</span>.<span class="ident">pop</span>().<span class="ident">unwrap</span>().<span class="ident">join</span>().<span class="ident">unwrap</span>();}

	<span class="ident">mino_list</span>.<span class="ident">push</span>(<span class="ident">Arc</span>::<span class="ident">try_unwrap</span>(<span class="ident">tmp</span>).<span class="ident">unwrap</span>()
		       .<span class="ident">into_inner</span>().<span class="ident">unwrap</span>());
	
    }

    <span class="ident">mino_list</span>
    
}
</pre></div>
</section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../../";window.currentCrate = "s1_noisefloor_engine";</script><script src="../../aliases.js"></script><script src="../../main.js"></script><script src="../../source-script.js"></script><script src="../../source-files.js"></script><script defer src="../../search-index.js"></script></body></html>